{% extends 'base.html' %}
{% load static %}

{% block title %}Shopping Cart | Golden Mais{% endblock %}

{% block content %}
<!-- Cart Header -->
<section class="py-12 px-8 bg-yellow-50">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-yellow-800 mb-2">Shopping Cart</h1>
        <p class="text-gray-600">Review your items before checkout</p>
    </div>
</section>

<!-- Cart Content -->
<section class="py-16 px-8">
    <div class="max-w-6xl mx-auto">
        <!-- Hidden CSRF token for AJAX requests -->
        <form style="display: none;">
            {% csrf_token %}
        </form>
        {% if cart_items %}
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Cart Items -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="px-6 py-4 bg-gray-50 border-b">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-semibold text-gray-800">Cart Items ({{ cart.get_total_items }} items)</h2>
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" 
                                       id="select-all-checkbox" 
                                       class="w-4 h-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                <label for="select-all-checkbox" class="text-sm text-gray-600 cursor-pointer">Select All</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="divide-y divide-gray-200">
                        {% for item in cart_items %}
                        <div class="p-6 flex items-center space-x-4">
                            <!-- Selection Checkbox -->
                            <div class="flex-shrink-0">
                                <input type="checkbox" 
                                       class="cart-item-checkbox w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500" 
                                       data-item-id="{{ item.id }}" 
                                       data-price="{{ item.get_total_price }}">
                            </div>
                            
                            <!-- Product Image -->
                            <div class="flex-shrink-0">
                                <a href="{% url 'product_detail' item.product.slug %}" class="block">
                                    {% if item.product.image %}
                                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" 
                                             class="w-20 h-20 object-cover rounded-lg hover:scale-105 transition-transform duration-300 cursor-pointer">
                                    {% else %}
                                        <div class="w-20 h-20 bg-gray-200 rounded-lg flex items-center justify-center hover:bg-gray-300 transition-colors cursor-pointer">
                                            <i class="fas fa-image text-gray-400"></i>
                                        </div>
                                    {% endif %}
                                </a>
                            </div>

                            <!-- Product Details -->
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-medium text-gray-900">
                                    <a href="{% url 'product_detail' item.product.slug %}" class="hover:text-green-600">
                                        {{ item.product.name }}
                                    </a>
                                </h3>
                                <p class="text-sm text-gray-500 mt-1">{{ item.product.description|truncatewords:10 }}</p>
                                <p class="text-lg font-semibold text-green-600 mt-2">₱{{ item.product.price }}</p>
                            </div>

                            <!-- Quantity Controls -->
                            <div class="flex items-center space-x-3">
                                <div class="flex items-center space-x-2">
                                    <input type="number" 
                                           id="qty-{{ item.id }}" 
                                           class="quantity-input w-16 px-2 py-1 border border-gray-300 rounded-lg text-center font-medium focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                           value="{{ item.quantity }}" 
                                           min="1" 
                                           max="{{ item.product.stock_quantity }}"
                                           data-item-id="{{ item.id }}"
                                           onchange="updateQuantityFromInput({{ item.id }}, this.value)">
                                </div>
                            </div>

                            <!-- Item Total -->
                            <div class="text-right">
                                <p class="item-total text-lg font-semibold text-gray-900" data-item-id="{{ item.id }}">₱{{ item.get_total_price }}</p>
                                <button onclick="removeItem({{ item.id }})" class="remove-btn text-red-600 hover:text-red-800 text-sm mt-2" data-item-id="{{ item.id }}">
                                    <i class="fas fa-trash mr-1"></i>Remove
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Continue Shopping -->
                <div class="mt-6">
                    <a href="{% url 'products' %}" 
                       class="inline-flex items-center text-green-600 hover:text-green-800">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Continue Shopping
                    </a>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-6 sticky top-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Order Summary</h2>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Subtotal (<span id="selected-items-count">{{ cart.get_total_items }}</span> items)</span>
                            <span class="font-medium">₱<span id="selected-subtotal">{{ cart.get_total_price }}</span></span>
                        </div>
                        
                        <div class="flex justify-between">
                            <span class="text-gray-600">Delivery Fee</span>
                            <span class="text-green-600 font-medium">FREE</span>
                        </div>
                        
                        <div class="border-t pt-3">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-semibold text-gray-900">Total</span>
                                <span class="text-lg font-semibold text-green-600">₱<span id="selected-total">{{ cart.get_total_price }}</span></span>
                            </div>
                        </div>
                        
                        <!-- Selected Items Notice -->
                        <div id="selection-notice" class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden">
                            <div class="flex items-center">
                                <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                                <p class="text-sm text-blue-800">
                                    Only selected items will be included in checkout.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Checkout Button -->
                    <div class="mt-6 space-y-2">
                        <button onclick="proceedToCheckoutWithSelected()" id="checkout-btn" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 transition">
                            Proceed to Checkout (<span id="checkout-items-count">{{ cart.get_total_items }}</span> items)
                        </button>
                        
                        <!-- Alternative direct checkout link -->
                        <a href="{% url 'checkout' %}" class="w-full bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700 transition block text-center text-sm">
                            <i class="fas fa-external-link-alt mr-1"></i>Direct Checkout (All Items)
                        </a>
                        
                        <!-- Fallback link for when JavaScript is disabled -->
                        <noscript>
                            <a href="{% url 'checkout' %}" class="w-full mt-2 bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 transition block text-center">
                                Proceed to Checkout ({{ cart.get_total_items }} items)
                            </a>
                        </noscript>
                    </div>


                    <!-- Delivery Info -->
                    <div class="mt-6 p-4 bg-green-50 rounded-lg">
                        <div class="flex items-start space-x-3">
                            <i class="fas fa-truck text-green-600 mt-1"></i>
                            <div>
                                <p class="text-sm font-medium text-green-800">Free Delivery</p>
                                <p class="text-xs text-green-600">Within Calubian, Leyte and nearby areas</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% else %}
        <!-- Empty Cart -->
        <div class="text-center py-16">
            <div class="max-w-md mx-auto">
                <i class="fas fa-shopping-cart text-6xl text-gray-300 mb-6"></i>
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Your cart is empty</h2>
                <p class="text-gray-600 mb-8">Looks like you haven't added any items to your cart yet.</p>
                
                <a href="{% url 'products' %}" 
                   class="inline-block bg-green-600 text-white font-semibold py-3 px-8 rounded-lg hover:bg-green-700 transition">
                    Start Shopping
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</section>

{% endblock %}

{% block extra_js %}
<script>

    // Toggle select all functionality
    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const itemCheckboxes = document.querySelectorAll('.cart-item-checkbox');
        
        itemCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
        
        updateSelectedTotal();
    }

    // Update selected items total (preserves checkbox states)
    function updateSelectedTotal() {
        const selectedCheckboxes = document.querySelectorAll('.cart-item-checkbox:checked');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const allCheckboxes = document.querySelectorAll('.cart-item-checkbox');
        
        let selectedTotal = 0;
        let selectedCount = 0;
        
        selectedCheckboxes.forEach(checkbox => {
            selectedTotal += parseFloat(checkbox.dataset.price);
            selectedCount++;
        });
        
        // Update UI - show cart total when nothing is selected, selected total when items are selected
        if (selectedCount === 0) {
            // Show full cart totals when nothing is selected
            const cartTotal = Array.from(allCheckboxes).reduce((total, checkbox) => {
                return total + parseFloat(checkbox.dataset.price);
            }, 0);
            document.getElementById('selected-items-count').textContent = allCheckboxes.length;
            document.getElementById('selected-subtotal').textContent = cartTotal.toFixed(2);
            document.getElementById('selected-total').textContent = cartTotal.toFixed(2);
            document.getElementById('checkout-items-count').textContent = allCheckboxes.length;
        } else {
            // Show selected totals when items are selected
            document.getElementById('selected-items-count').textContent = selectedCount;
            document.getElementById('selected-subtotal').textContent = selectedTotal.toFixed(2);
            document.getElementById('selected-total').textContent = selectedTotal.toFixed(2);
            document.getElementById('checkout-items-count').textContent = selectedCount;
        }
        
        // Update select all checkbox state WITHOUT triggering events
        if (selectedCount === 0) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
        } else if (selectedCount === allCheckboxes.length) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = true;
        } else {
            selectAllCheckbox.indeterminate = true;
        }
        
        // Show/hide selection notice
        const selectionNotice = document.getElementById('selection-notice');
        if (selectedCount < allCheckboxes.length && selectedCount > 0) {
            selectionNotice.classList.remove('hidden');
        } else {
            selectionNotice.classList.add('hidden');
        }
        
        // Update checkout button state - always enabled since no selection means all items
        const checkoutBtn = document.getElementById('checkout-btn');
        checkoutBtn.disabled = false;
        checkoutBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
        checkoutBtn.classList.add('bg-green-600', 'hover:bg-green-700');
    }
    
    // AJAX function to update cart item quantity from input field
    function updateQuantityFromInput(itemId, newQuantity) {
        newQuantity = parseInt(newQuantity);
        if (newQuantity < 1) {
            alert('Quantity must be at least 1');
            location.reload();
            return;
        }
        
        // Show loading state
        const quantityInput = document.querySelector(`#qty-${itemId}`);
        const originalQuantity = quantityInput.value;
        quantityInput.disabled = true;
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch(`/update-cart-item/${itemId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            },
            body: `quantity=${newQuantity}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update quantity input
                quantityInput.value = data.new_quantity;
                
                // Update item total
                const itemTotal = document.querySelector(`[data-item-id="${itemId}"].item-total`);
                itemTotal.textContent = `₱${data.item_total.toFixed(2)}`;
                
                // Update cart totals
                document.getElementById('selected-subtotal').textContent = data.cart_total.toFixed(2);
                document.getElementById('selected-total').textContent = data.cart_total.toFixed(2);
                
                // Update checkbox data-price attribute
                const checkbox = document.querySelector(`[data-item-id="${itemId}"].cart-item-checkbox`);
                if (checkbox) {
                    checkbox.dataset.price = data.item_total.toFixed(2);
                }
                
                // Update selected totals
                updateSelectedTotal();
            } else {
                // Restore original quantity on error
                quantityInput.value = originalQuantity;
                alert(data.error || 'Error updating cart. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            quantityInput.value = originalQuantity;
            alert('Error updating cart. Please try again.');
        })
        .finally(() => {
            quantityInput.disabled = false;
        });
    }
    
    // AJAX function to remove item from cart
    function removeItem(itemId) {
        if (!confirm('Are you sure you want to remove this item from your cart?')) {
            return;
        }
        
        // Show loading state
        const removeBtn = document.querySelector(`[data-item-id="${itemId}"].remove-btn`);
        const originalText = removeBtn.innerHTML;
        removeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Removing...';
        removeBtn.disabled = true;
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch(`/remove-from-cart/${itemId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the entire item row
                const itemRow = removeBtn.closest('.p-6');
                itemRow.remove();
                
                // Update cart totals
                document.getElementById('selected-subtotal').textContent = data.cart_total.toFixed(2);
                document.getElementById('selected-total').textContent = data.cart_total.toFixed(2);
                
                // Update selected totals
                updateSelectedTotal();
                
                // Reload page if no items left
                if (data.cart_count === 0) {
                    window.location.reload();
                }
            } else {
                removeBtn.innerHTML = originalText;
                removeBtn.disabled = false;
                alert('Error removing item. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            removeBtn.innerHTML = originalText;
            removeBtn.disabled = false;
            alert('Error removing item. Please try again.');
        });
    }

    // Proceed to checkout with selected items
    function proceedToCheckoutWithSelected() {
        const selectedCheckboxes = document.querySelectorAll('.cart-item-checkbox:checked');
        
        if (selectedCheckboxes.length === 0) {
            alert('Please select at least one item to checkout.');
            return;
        }
        
        // For now, just redirect to checkout page normally
        // The selective checkout feature can be implemented in the backend later
        window.location.href = '{% url "checkout" %}';
        
        // TODO: Implement selective checkout in the backend
        // Get selected item IDs for future implementation
        const selectedItemIds = Array.from(selectedCheckboxes).map(checkbox => checkbox.dataset.itemId);
        console.log('Selected items for checkout:', selectedItemIds);
    }


    // Auto-update cart totals (if using AJAX)
    function updateCartItem(itemId, quantity) {
        // AJAX implementation for real-time cart updates
        console.log('Updating item', itemId, 'to quantity', quantity);
    }

    // Initialize event listeners when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Select all checkbox event listener
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', toggleSelectAll);
        }
        
        // Individual item checkboxes event listeners
        const itemCheckboxes = document.querySelectorAll('.cart-item-checkbox');
        itemCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedTotal);
        });
        
        // Initialize totals
        updateSelectedTotal();
        
        // Add CSRF token to all AJAX requests
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            window.csrfToken = csrfToken.value;
        }
    });
</script>
{% endblock %}
