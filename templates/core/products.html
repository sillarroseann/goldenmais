{% extends 'base.html' %}
{% load static %}

{% block title %}Golden Mais | Products{% endblock %}

{% block extra_css %}
<style>
    .floating-card {
        transition: transform 0.35s ease, box-shadow 0.35s ease, border-color 0.35s ease;
        border: 1px solid transparent;
    }

    .floating-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 45px rgba(0, 0, 0, 0.12);
    }

    .combo-selectable-card.selected {
        border-color: #facc15;
        box-shadow: 0 25px 55px rgba(250, 204, 21, 0.35);
        transform: translateY(-12px) scale(1.01);
    }

    .combo-selectable-card .selection-pill {
        display: none;
    }

    .combo-selectable-card.selected .selection-pill {
        display: inline-flex;
    }

    .cart-icon-pulse {
        animation: cartPulse 0.5s ease;
    }

    @keyframes cartPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.25); }
        100% { transform: scale(1); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero / Banner Section -->
<section class="relative h-[75vh] flex items-center justify-center text-center text-white overflow-hidden rounded-b-[2rem]">
    <img src="{% static 'img/banner.jpg' %}" alt="Baskets of Fresh Corn" class="absolute inset-0 w-full h-full object-cover brightness-75" />
    <div class="relative z-10 px-6 max-w-2xl">
        <h1 class="text-4xl md:text-6xl font-bold mb-6">Our Fresh Farm Products</h1>
        <p class="text-lg md:text-xl text-yellow-100 leading-relaxed">
            Handpicked sweet corn and other locally grown favorites, delivered fresh to your doorstep.
        </p>
    </div>
</section>

<!-- Product Introduction -->
<section class="py-16 px-8 bg-green-500 text-center">
    <h2 class="text-3xl font-bold text-yellow-800 mb-4">Fresh from the Fields üåΩ</h2>
    <p class="text-gray-700 max-w-3xl mx-auto leading-relaxed">
        At <span class="font-semibold text-yellow-800">Golden Mais</span>, we take pride in providing only the freshest, most flavorful sweet corn and locally grown produce. Every cob is handpicked, ensuring quality, sweetness, and that irresistible farm-fresh taste ‚Äî ready for your table.
    </p>
</section>


<!-- Product Grid / Listing Section -->
<section class="py-16 px-8 bg-yellow-50">
    <div class="max-w-7xl mx-auto">
        <h2 class="text-3xl font-bold text-yellow-800 text-center mb-10">Explore Our Corn-Based Products</h2>

        {% if products %}
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
            {% for product in products %}
            <div class="bg-white shadow-lg rounded-xl overflow-hidden hover:shadow-xl transition product-card">
                <div class="relative">
                    <a href="{% url 'product_detail' product.slug %}" class="block">
                        {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="w-full h-56 object-cover hover:scale-105 transition-transform duration-300 cursor-pointer" />
                        {% else %}
                            <img src="{% static 'img/dozenfreshcorn.jpg' %}" alt="{{ product.name }}" class="w-full h-56 object-cover hover:scale-105 transition-transform duration-300 cursor-pointer" />
                        {% endif %}
                    </a>
                    
                    {% if product.is_new %}
                        <span class="absolute top-3 left-3 bg-green-600 text-white text-xs px-2 py-1 rounded-full">New Harvest</span>
                    {% elif product.is_bestseller %}
                        <span class="absolute top-3 left-3 bg-red-600 text-white text-xs px-2 py-1 rounded-full">Best Seller</span>
                    {% elif product.free_delivery %}
                        <span class="absolute top-3 left-3 bg-blue-600 text-white text-xs px-2 py-1 rounded-full">Free Delivery</span>
                    {% endif %}
                </div>
                <div class="p-5">
                    <h3 class="text-lg font-bold text-green-600">{{ product.name }}</h3>
                    <p class="text-gray-600 text-sm mt-2">{{ product.description|truncatewords:15 }}</p>
                    <div class="flex items-center justify-between mt-4">
                        <span class="text-green-600 font-semibold text-lg">‚Ç±{{ product.price }}</span>
                        <div class="space-x-2">
                            <a href="{% url 'product_detail' product.slug %}" 
                               class="bg-blue-600 text-white text-sm px-3 py-2 rounded-lg hover:bg-blue-700 transition">
                                View Details
                            </a>
                            {% if user.is_authenticated %}
                                <button onclick="addToCartFromListing({{ product.id }}, this)" 
                                        class="bg-green-600 text-white text-sm px-3 py-2 rounded-lg hover:bg-green-700 transition">
                                    <i class="fas fa-shopping-cart mr-1"></i>
                                    Add to Cart
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if products.has_previous or products.has_next %}
        <div class="mt-12 flex justify-center">
            <nav class="flex space-x-2" id="pagination-nav">
                {% if products.has_previous %}
                    <button onclick="loadPage({{ products.previous_page_number }})" 
                            class="px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Previous</button>
                {% endif %}

                {% for num in products.paginator.page_range %}
                    {% if products.number == num %}
                        <span class="px-3 py-2 bg-green-600 text-white rounded">{{ num }}</span>
                    {% else %}
                        <button onclick="loadPage({{ num }})" 
                                class="px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">{{ num }}</button>
                    {% endif %}
                {% endfor %}

                {% if products.has_next %}
                    <button onclick="loadPage({{ products.next_page_number }})" 
                            class="px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Next</button>
                {% endif %}
            </nav>
        </div>
        {% endif %}

        {% else %}
        <div class="text-center py-12">
            <p class="text-gray-500 text-lg">No products found matching your criteria.</p>
            <a href="{% url 'products' %}" class="mt-4 inline-block bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
                View All Products
            </a>
        </div>
        {% endif %}
    </div>
</section>

<!-- Featured Combo / Promo Section -->
{% if featured_combos %}
<section class="py-16 px-8 bg-yellow-200">
    <div class="max-w-7xl mx-auto text-center">
        <h2 class="text-3xl font-bold text-yellow-800 mb-4">Featured Combos & Promos üéÅ</h2>
        <p class="text-gray-700 max-w-2xl mx-auto mb-10">
            Enjoy our special bundle deals ‚Äî perfect for families, gatherings, or sweet corn lovers!
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
            {% for combo in featured_combos %}
            <div class="bg-white shadow-lg rounded-2xl overflow-hidden hover:shadow-2xl transition floating-card combo-selectable-card cursor-pointer">
                {% if combo.image %}
                    <img src="{{ combo.image.url }}" alt="{{ combo.name }}" class="w-full h-64 object-cover" />
                {% else %}
                    <img src="{% static 'img/familycornpack.jpg' %}" alt="{{ combo.name }}" class="w-full h-64 object-cover" />
                {% endif %}
                <div class="p-6 text-left">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-2xl font-bold text-green-600">{{ combo.name }} üåΩ</h3>
                        <span class="selection-pill text-xs font-semibold px-3 py-1 rounded-full bg-yellow-200 text-yellow-800">
                            <i class="fas fa-check mr-1"></i>Selected
                        </span>
                    </div>
                    <p class="text-gray-700 text-sm mb-4">{{ combo.description }}</p>
                    <div class="flex items-center justify-between">
                        <span class="text-green-600 font-semibold text-lg">‚Ç±{{ combo.price }}</span>
                        <a href="{% url 'product_detail' combo.slug %}" 
                           class="bg-green-600 text-white px-5 py-2 rounded-lg text-sm hover:bg-green-700 transition">
                            Shop Bundle
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Customer Reviews / Testimonials Section -->
{% if customer_reviews %}
<section class="py-20 px-8 bg-yellow-50">
    <div class="max-w-6xl mx-auto text-center">
        <h2 class="text-3xl font-bold text-yellow-800 mb-6">What Our Customers Say üíõ</h2>
        <p class="text-gray-700 mb-12 max-w-2xl mx-auto">
            Hear from our happy customers who enjoy the freshness, sweetness, and local goodness of Golden Mais products!
        </p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
            {% for review in customer_reviews %}
            <div class="bg-green-300 shadow-lg rounded-2xl p-6 flex flex-col items-center text-center hover:shadow-xl transition">
                <div class="w-16 h-16 rounded-full mb-4 bg-gray-300 flex items-center justify-center">
                    <i class="fas fa-user text-gray-600 text-2xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-yellow-800">{{ review.customer.user.get_full_name|default:review.customer.user.username }}</h3>
                <p class="text-sm text-gray-600 italic mb-3">"{{ review.comment|truncatewords:15 }}"</p>
                <div class="flex justify-center space-x-1 text-yellow-500 text-xl">
                    {% for i in "12345" %}
                        {% if forloop.counter <= review.rating %}‚≠ê{% else %}‚òÜ{% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Delivery & Pickup Information -->
<section class="py-20 px-8 bg-yellow-200 text-center rounded-t-[2rem]">
    <div class="max-w-4xl mx-auto">
        <h2 class="text-3xl font-bold text-yellow-800 mb-6">Delivery & Pickup Information üöõ</h2>
        <p class="text-gray-700 text-lg leading-relaxed max-w-2xl mx-auto">
            We offer <span class="font-semibold text-yellow-900">FREE delivery</span> within
            <span class="font-semibold">Calubian, Leyte</span> and nearby areas.
            <br />
            <span class="font-semibold text-yellow-900">Same-day pickup</span> is also available
            from <strong>8:00 AM to 5:00 PM</strong> at our farm store.
        </p>

        <div class="mt-10 flex flex-col md:flex-row justify-center gap-10">
            <!-- Delivery Card -->
            <div class="bg-green-300 shadow-lg rounded-2xl p-6 flex-1 hover:shadow-xl transition">
                <i class="fa-solid fa-truck text-4xl text-yellow-700 mb-3"></i>
                <h3 class="text-xl font-semibold text-yellow-800 mb-2">Free Local Delivery</h3>
                <p class="text-gray-700 text-sm">
                    Enjoy doorstep delivery for orders within Calubian and nearby towns ‚Äî fast, fresh, and free!
                </p>
            </div>

            <!-- Pickup Card -->
            <div class="bg-green-300 shadow-lg rounded-2xl p-6 flex-1 hover:shadow-xl transition">
                <i class="fa-solid fa-store text-4xl text-yellow-700 mb-3"></i>
                <h3 class="text-xl font-semibold text-yellow-800 mb-2">Same-Day Pickup</h3>
                <p class="text-gray-700 text-sm">
                    Visit our farm shop for same-day pickup. Open from 8:00 AM to 5:00 PM, Monday to Saturday.
                </p>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const comboCards = document.querySelectorAll('.combo-selectable-card');
    let selectedCard = null;

    comboCards.forEach(card => {
        card.addEventListener('click', () => {
            if (selectedCard === card) {
                card.classList.toggle('selected');
                selectedCard = card.classList.contains('selected') ? card : null;
                return;
            }

            comboCards.forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedCard = card;
        });
    });
});

function addToCartAndRedirect(event, form) {
    event.preventDefault();
    
    // Show loading state
    const button = form.querySelector('button[type="submit"]');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Adding...';
    button.disabled = true;
    
    // Submit form via AJAX
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            button.innerHTML = '<i class="fas fa-check mr-2"></i>Added!';
            button.classList.remove('bg-green-600', 'hover:bg-green-700');
            button.classList.add('bg-green-800');
            
            // Redirect to cart after short delay
            setTimeout(() => {
                window.location.href = '/cart/';
            }, 1000);
        } else {
            // Show error message
            button.innerHTML = originalText;
            button.disabled = false;
            alert('Error adding to cart. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        button.innerHTML = originalText;
        button.disabled = false;
        alert('Error adding to cart. Please try again.');
    });
    
    return false;
}

// CSRF token for AJAX requests
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Add to Cart from product listing (AJAX - no redirect)
function addToCartFromListing(productId, button) {
    const originalText = button.innerHTML;
    
    // Show loading state
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Adding...';
    button.disabled = true;
    
    // Prepare form data
    const formData = new FormData();
    formData.append('quantity', '1');
    formData.append('stay_on_page', 'true');
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    // Send AJAX request
    fetch(`/add-to-cart/${productId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            flyProductToCart(button);
            // Show success message
            button.innerHTML = '<i class="fas fa-check mr-1"></i>Added!';
            button.classList.remove('bg-green-600', 'hover:bg-green-700');
            button.classList.add('bg-green-800');
            
            // Update cart count in navigation if exists
            const cartCount = document.querySelector('.cart-count');
            if (cartCount) {
                cartCount.textContent = data.cart_count;
            }
            if (typeof updateCartBadge === 'function') {
                updateCartBadge(data.cart_count);
            }
            
            // Reset button after 2 seconds
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('bg-green-800');
                button.classList.add('bg-green-600', 'hover:bg-green-700');
                button.disabled = false;
            }, 2000);
        } else {
            // Show error message
            button.innerHTML = originalText;
            button.disabled = false;
            alert('Error adding to cart. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        button.innerHTML = originalText;
        button.disabled = false;
        alert('Error adding to cart. Please try again.');
    });
}

function flyProductToCart(button) {
    const cartIcon = document.querySelector('.cart-icon-target');
    if (!cartIcon) return;
    const card = button.closest('.product-card');
    const image = card ? card.querySelector('img') : null;
    const sourceRect = (image || button).getBoundingClientRect();
    const targetRect = cartIcon.getBoundingClientRect();
    const flyer = image ? image.cloneNode(true) : document.createElement('div');
    if (!image) {
        flyer.style.width = '40px';
        flyer.style.height = '40px';
        flyer.style.background = '#facc15';
        flyer.style.borderRadius = '9999px';
    }
    flyer.style.position = 'fixed';
    flyer.style.left = `${sourceRect.left}px`;
    flyer.style.top = `${sourceRect.top}px`;
    flyer.style.width = `${sourceRect.width}px`;
    flyer.style.height = `${sourceRect.height}px`;
    flyer.style.transition = 'transform 0.6s ease, opacity 0.6s ease';
    flyer.style.zIndex = '9999';
    flyer.style.pointerEvents = 'none';
    document.body.appendChild(flyer);
    requestAnimationFrame(() => {
        const translateX = targetRect.left - sourceRect.left;
        const translateY = targetRect.top - sourceRect.top;
        flyer.style.transform = `translate(${translateX}px, ${translateY}px) scale(0.2)`;
        flyer.style.opacity = '0.3';
    });
    setTimeout(() => {
        flyer.remove();
        cartIcon.classList.add('cart-icon-pulse');
        setTimeout(() => cartIcon.classList.remove('cart-icon-pulse'), 500);
    }, 650);
}

// AJAX pagination function
function loadPage(pageNumber) {
    // Show loading state
    const paginationNav = document.getElementById('pagination-nav');
    const originalContent = paginationNav.innerHTML;
    paginationNav.innerHTML = '<div class="px-3 py-2 text-gray-500">Loading...</div>';
    
    // Make AJAX request
    fetch(`?page=${pageNumber}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.text())
    .then(html => {
        // Create a temporary div to parse the response
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        
        // Extract the product grid and pagination
        const newProductGrid = tempDiv.querySelector('.grid.grid-cols-1.sm\\:grid-cols-2.lg\\:grid-cols-3.gap-8');
        const newPagination = tempDiv.querySelector('#pagination-nav');
        
        // Update the product grid
        const currentProductGrid = document.querySelector('.grid.grid-cols-1.sm\\:grid-cols-2.lg\\:grid-cols-3.gap-8');
        if (newProductGrid && currentProductGrid) {
            currentProductGrid.innerHTML = newProductGrid.innerHTML;
        }
        
        // Update pagination
        if (newPagination && paginationNav) {
            paginationNav.innerHTML = newPagination.innerHTML;
        }
        
        // Scroll to top of products section smoothly
        document.querySelector('.max-w-7xl.mx-auto h2').scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
        });
    })
    .catch(error => {
        console.error('Error loading page:', error);
        paginationNav.innerHTML = originalContent;
        alert('Error loading page. Please try again.');
    });
}
</script>
{% endblock %}
